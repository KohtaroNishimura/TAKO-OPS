{% extends "base.html" %}
{% block content %}
<div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
  {% set group_label = "全材料" if group=="ALL" else ("食材" if group=="FOOD" else "消耗品") %}
  <h2
    id="stocktake-title"
    class="text-lg font-semibold text-slate-900"
    data-weekly="週次棚卸（{{ group_label }}）"
    data-monthly="月次棚卸（{{ group_label }}）"
  >
    {{ "週次棚卸（" ~ group_label ~ "）" if mode=="weekly" else "月次棚卸（" ~ group_label ~ "）" }}
  </h2>

  <div
    id="stocktake-help"
    class="muted mt-2"
    data-weekly="週末の出汁/生地ロスなど、実在庫に合わせて調整します。保存すると差分が inventory_tx に ADJUST 反映されます。"
    data-monthly="月末に倉庫へ寄せて棚卸します。保存すると差分が inventory_tx に ADJUST 反映されます。"
  >
    {% if mode=="weekly" %}
      週末の出汁/生地ロスなど、実在庫に合わせて調整します。保存すると差分が inventory_tx に ADJUST 反映されます。
    {% else %}
      月末に倉庫へ寄せて棚卸します。保存すると差分が inventory_tx に ADJUST 反映されます。
    {% endif %}
  </div>

  <form
    id="stocktake-form"
    method="post"
    action="{{ form_action if form_action is defined else url_for('stocktake_create_unified') }}"
  >
    <div class="grid gap-3 sm:grid-cols-2">
      <div>
        <label>棚卸区分</label>
        <select id="mode-select" name="mode">
          <option value="weekly" {{ "selected" if mode=="weekly" else "" }}>週次</option>
          <option value="monthly" {{ "selected" if mode=="monthly" else "" }}>月次</option>
        </select>
        <div class="muted">登録時に区分が切り替わります</div>
      </div>
      <div>
        <label>区分</label>
        <select id="group-select" name="group" {{ "disabled" if is_edit else "" }}>
          <option value="ALL" {{ "selected" if group=="ALL" else "" }}>全て</option>
          <option value="FOOD" {{ "selected" if group=="FOOD" else "" }}>食材（FOOD）</option>
          <option value="SUPPLIES" {{ "selected" if group=="SUPPLIES" else "" }}>消耗品（SUPPLIES）</option>
        </select>
        {% if is_edit %}
          <input type="hidden" name="group" value="{{ group }}">
          <div class="muted">編集時は全材料で固定です</div>
        {% endif %}
      </div>
    </div>

    <div class="mt-3 grid gap-3 sm:grid-cols-2">
      <div>
        <label>棚卸日時</label>
        <input name="taken_at" value="{{ default_taken_at }}" placeholder="YYYY-MM-DD HH:MM:SS">
        <div class="muted">空なら現在時刻になります</div>
      </div>
      <div>
        <label>メモ</label>
        <input
          id="stocktake-note"
          name="note"
          placeholder="{{ '例：週末ロス調整 / 棚卸など' if mode=='weekly' else '例：月末棚卸（倉庫に寄せ）' }}"
          data-weekly-placeholder="例：週末ロス調整 / 棚卸など"
          data-monthly-placeholder="例：月末棚卸（倉庫に寄せ）"
        >
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <table>
        <thead>
          <tr>
            <th>材料</th>
            <th class="hidden sm:table-cell">現在残量</th>
            <th>棚卸数（counted_qty）</th>
            <th class="muted hidden sm:table-cell">単位</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>
              <div class="font-medium text-slate-900">{{ r.name }}</div>
              <div class="muted sm:hidden">
                現在残量: {{ '%.3f'|format(r.current_qty) }} {{ r.unit_base }}
              </div>
            </td>
            <td class="hidden sm:table-cell">{{ '%.3f'|format(r.current_qty) }}</td>
            <td class="w-40 sm:w-[220px]">
              <input
                type="number"
                step="0.001"
                name="counted_{{ r.item_id }}"
                value="{{ '%.3f'|format(r.counted_default) }}"
                class="w-full"
              >
            </td>
            <td class="muted hidden sm:table-cell">{{ r.unit_base }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="actions">
        <button type="submit">{{ "更新して差分を反映" if is_edit else "保存して差分を反映" }}</button>
        <a class="button-link" href="{{ url_for('stocktakes_list') }}">戻る</a>
      </div>
    </div>
  </form>
</div>

<script>
  const modeSelect = document.getElementById("mode-select");
  const groupSelect = document.getElementById("group-select");
  const title = document.getElementById("stocktake-title");
  const help = document.getElementById("stocktake-help");
  const noteInput = document.getElementById("stocktake-note");

  const syncModeUi = () => {
    const mode = modeSelect.value;
    title.textContent = title.dataset[mode];
    help.textContent = help.dataset[mode];
    noteInput.placeholder = noteInput.dataset[`${mode}Placeholder`];
  };

  const syncGroupQuery = () => {
    const params = new URLSearchParams(window.location.search);
    params.set("group", groupSelect.value);
    params.set("mode", modeSelect.value);
    window.location.search = params.toString();
  };

  modeSelect.addEventListener("change", syncModeUi);
  groupSelect.addEventListener("change", syncGroupQuery);
  syncModeUi();
</script>
{% endblock %}
