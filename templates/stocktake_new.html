{% extends "base.html" %}
{% block content %}
  <div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">月次棚卸（入力）</h2>
    <p class="muted">
      入力した「実測値」と、在庫履歴（inventory_tx）の理論在庫を比べて差分を自動計算し、ADJUSTで反映します。
    </p>

    <form method="get" action="{{ url_for('stocktake_new_form') }}" class="mb-3">
      <label>表示対象</label>
      <select name="only_food">
        <option value="1" {{ "selected" if only_food else "" }}>食材原価（FOOD）のみ（38項目）</option>
        <option value="0" {{ "selected" if not only_food else "" }}>全材料（FOOD + 消耗品）</option>
      </select>

      <button type="submit" class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">表示を更新</button>
    </form>

    <form method="post" action="{{ url_for('stocktake_create') }}">
      <input type="hidden" name="only_food" value="{{ '1' if only_food else '0' }}">

      <div class="row grid gap-4 sm:grid-cols-2">
        <div>
          <label>棚卸日時（任意）</label>
          <input type="datetime-local" name="taken_at">
          <div class="muted">空なら「登録した時刻」になります</div>
        </div>
        <div>
          <label>メモ（任意）</label>
          <input name="note" placeholder="例：12月末 月次棚卸">
        </div>
      </div>

      <hr class="my-4 border-slate-200">

      <h3 class="text-base font-semibold text-slate-900">棚卸数量（実測）</h3>
      <p class="muted">
        表示している「理論在庫」は現時点の合計です（入力後、差分をADJUSTします）。
        未入力の行はスキップされます（今回は数えない扱い）。
      </p>

      <div class="overflow-x-auto -mx-4 sm:mx-0">

        <table class="min-w-[640px] w-full text-sm">
        <thead>
          <tr>
            <th>材料</th>
            <th>単位</th>
            <th>理論在庫（参考）</th>
            <th>棚卸数量（実測）</th>
          </tr>
        </thead>
        <tbody>
          {% for i in items %}
            {% set cur = current_map.get(i["item_id"], 0) %}
            <tr>
              <td>
                {{ i["name"] }}
                <span class="muted">（{{ i["cost_group"] }}）</span>
                <input type="hidden" name="item_id" value="{{ i['item_id'] }}">
              </td>
              <td>{{ i["unit_base"] }}</td>
              <td>{{ "%.2f"|format(cur) }}</td>
              <td>
                <input
                  name="counted_qty"
                  type="number"
                  min="0"
                  step="{{ '1' if i['unit_base']=='pcs' else '0.01' }}"
                  value="{{ ('%.0f'|format(cur)) if i['unit_base']=='pcs' else ('%.2f'|format(cur)) }}"
                  placeholder="例：{{ '%.2f'|format(cur) }}"
                >
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <div class="actions mt-4 flex flex-wrap items-center gap-2">
        <button class="btn inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400" type="submit"
          onclick="return confirm('棚卸を登録し、差分をADJUSTで反映します。よろしいですか？');">
          棚卸を登録して反映
        </button>
        <a class="btn secondary inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50" href="{{ url_for('stocktakes_list') }}">戻る</a>
      </div>
    </form>
  </div>
{% endblock %}
