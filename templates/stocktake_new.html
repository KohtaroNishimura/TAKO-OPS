{% extends "base.html" %}
{% block content %}
<div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
  <h2 class="text-lg font-semibold text-slate-900">
    {{ "週次棚卸（全材料）" if mode=="weekly" else "月次棚卸（全材料）" }}
  </h2>

  <div class="mt-2 flex flex-wrap gap-2 text-sm font-semibold">
    <a
      class="rounded-full border px-3 py-1.5 {{ 'border-slate-900 bg-slate-900 text-white' if mode=='weekly' else 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50' }}"
      href="{{ url_for('stocktake_weekly_new') }}"
    >週次</a>
    <a
      class="rounded-full border px-3 py-1.5 {{ 'border-slate-900 bg-slate-900 text-white' if mode=='monthly' else 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50' }}"
      href="{{ url_for('stocktake_monthly_new') }}"
    >月次</a>
  </div>

  <div class="muted mt-2">
    {% if mode=="weekly" %}
      週末の出汁/生地ロスなど、実在庫に合わせて調整します。保存すると差分が inventory_tx に ADJUST 反映されます。
    {% else %}
      月末に倉庫へ寄せて棚卸します。保存すると差分が inventory_tx に ADJUST 反映されます。
    {% endif %}
  </div>

  <form method="post" action="{{ url_for('stocktake_weekly_new') if mode=='weekly' else url_for('stocktake_monthly_create') }}">
    <div class="row">
      <div>
        <label>棚卸日時</label>
        <input name="taken_at" value="{{ default_taken_at }}" placeholder="YYYY-MM-DD HH:MM:SS">
        <div class="muted">空なら現在時刻になります</div>
      </div>
      <div>
        <label>メモ</label>
        <input name="note" placeholder="{{ '例：週末ロス調整 / 棚卸など' if mode=='weekly' else '例：月末棚卸（倉庫に寄せ）' }}">
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <table>
        <thead>
          <tr>
            <th>材料</th>
            <th>区分</th>
            <th>現在在庫</th>
            <th>棚卸数（counted_qty）</th>
            <th class="muted">単位</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.name }}</td>
            <td><span class="pill">{{ r.cost_group }}</span></td>
            <td>{{ '%.3f'|format(r.current_qty) }}</td>
            <td style="width:220px;">
              <input
                type="number"
                step="0.001"
                name="counted_{{ r.item_id }}"
                value="{{ '%.3f'|format(r.counted_default) }}"
              >
            </td>
            <td class="muted">{{ r.unit_base }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="actions">
        <button type="submit">保存して差分を反映</button>
        <a class="button-link" href="{{ url_for('stocktakes_list') }}">戻る</a>
      </div>
    </div>
  </form>
</div>
{% endblock %}
