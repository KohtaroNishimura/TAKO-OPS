{% extends "base.html" %}
{% block content %}
  <div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">移動登録（倉庫⇄店舗）</h2>

    <form method="post" action="{{ url_for('transfer_create') }}">
      <div class="row grid gap-4 sm:grid-cols-2">
        <div>
          <label>移動日（任意）</label>
          <input type="date" name="moved_date"
            value="{{ default_moved_date if default_moved_date is defined else '' }}">
          <div class="muted">空なら今日</div>
        </div>
        <div>
          <label>移動元</label>
          <select name="from_location">
            <option value="WAREHOUSE" {{ "selected" if default_from_location is defined and default_from_location=="WAREHOUSE" else "" }}>WAREHOUSE（倉庫/自宅）</option>
            <option value="STORE" {{ "selected" if default_from_location is defined and default_from_location=="STORE" else "" }}>STORE（店舗/トレーラー）</option>
          </select>
        </div>
        <div>
          <label>移動先</label>
          <select name="to_location">
            <option value="STORE" {{ "selected" if default_to_location is defined and default_to_location=="STORE" else "" }}>STORE（店舗/トレーラー）</option>
            <option value="WAREHOUSE" {{ "selected" if default_to_location is defined and default_to_location=="WAREHOUSE" else "" }}>WAREHOUSE（倉庫/自宅）</option>
          </select>
        </div>
      </div>

      <label>メモ（任意）</label>
      <input name="note" value="{{ default_note if default_note is defined else '' }}" placeholder="例：営業前にトレーラーへ補充">

      <hr class="my-4 border-slate-200">

      <h3 class="text-base font-semibold text-slate-900">明細（最大10行）</h3>
      <div class="overflow-x-auto -mx-4 sm:mx-0">
        <table class="min-w-[640px] w-full text-sm">
        <thead>
          <tr>
            <th class="w-[60%]">材料</th>
            <th class="w-[40%]">数量</th>
          </tr>
        </thead>
        {% set prefill = prefill_lines if prefill_lines is defined else [] %}
        <tbody>
          {% for idx in range(10) %}
            {% set pl = prefill[idx] if idx < (prefill|length) else None %}
            <tr>
              <td>
                <select name="item_id">
                  <option value="">選択してください</option>
                  {% for i in items %}
                    <option value="{{ i['item_id'] }}"
                      {{ "selected" if pl and pl["item_id"] == i["item_id"] else "" }}>
                      {{ i['name'] }}（{{ i['unit_base'] }}）
                    </option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <input name="qty" type="number" step="0.01" min="0"
                       value="{{ '%.2f'|format(pl['qty']) if pl else '' }}"
                       placeholder="例：1">
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <div class="actions mt-4 flex flex-wrap items-center gap-2">
        <button class="btn inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400" type="submit"
          onclick="return confirm('移動を登録し、在庫履歴（TRANSFER）を2地点に反映します。よろしいですか？');">
          登録する
        </button>
        <a class="btn secondary inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50" href="{{ url_for('transfers_list') }}">戻る</a>
      </div>
    </form>
  </div>
{% endblock %}
