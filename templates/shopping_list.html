{% extends "base.html" %}
{% block content %}
  <div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">買い物リスト（発注目安以下）</h2>

    <p class="muted">基準：TOTAL（倉庫+店舗 合算）</p>

    {% if grouped|length == 0 %}
      <p>発注目安以下の材料はありません。</p>
    {% endif %}

    {% for g in grouped %}
      <hr class="my-4 border-slate-200">
      <h3 class="text-base font-semibold text-slate-900">{{ g.supplier_name }}</h3>
      <p class="muted">目安合計：{{ "%.0f"|format(g.est_sum) }}（参考価格ベース）</p>

      <form method="post" action="{{ url_for('purchase_new_from_list') }}">

        {% set sid = (g["items"][0]["supplier_id"] if g["items"]|length>0 else None) %}
        <input type="hidden" name="supplier_id" value="{{ sid if sid is not none else '' }}">

        <div class="overflow-x-auto -mx-4 sm:mx-0">

          <table class="min-w-[640px] w-full text-sm">
          <thead>
            <tr>
              <th>✓</th>
              <th>材料</th>
              <th>区分</th>
              <th>現在庫</th>
              <th>発注目安</th>
              <th>推奨発注量</th>
              <th>単位</th>
              <th>参考単価</th>
              <th>目安金額</th>
              <th>固定</th>
            </tr>
          </thead>
          <tbody>
            {% for i in g["items"] %}
              <tr>
                <td>
                  <input type="checkbox" name="selected_item_ids" value="{{ i.item_id }}">
                </td>
                <td>{{ i.name }}</td>
                <td>{{ "食材" if i.cost_group=="FOOD" else "消耗品" }}</td>
                <td>{{ "%.2f"|format(i.qty) }}</td>
                <td>{{ "%.2f"|format(i.reorder_point) }}</td>

                <td>
                  <input
                    type="number"
                    step="{{ '1' if i.unit_base=='pcs' else '0.01' }}"
                    min="0"
                    name="qty_{{ i.item_id }}"
                    value="{{ ('%.0f'|format(i.order_qty)) if i.unit_base=='pcs' else ('%.2f'|format(i.order_qty)) }}"
                    class="w-[120px]"
                  >
                </td>

                <td>{{ i.unit_base }}</td>

                <td>
                  <input
                    type="number"
                    step="1"
                    min="0"
                    name="unit_price_{{ i.item_id }}"
                    value="{{ '%.0f'|format(i.ref_unit_price or 0) }}"
                    class="w-[100px]"
                  >
                </td>

                <td>{{ "%.0f"|format(i.est_amount or 0) }}</td>
                <td>{{ "✓" if i.is_fixed else "" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>

        <div class="actions mt-4 flex flex-wrap items-center gap-2">
          <button class="btn inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400" type="submit">
            チェックした材料で入庫登録へ
          </button>
          <span class="muted">※最大10件までフォームに反映</span>
        </div>
      </form>
    {% endfor %}
  </div>
{% endblock %}
