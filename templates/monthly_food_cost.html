{% extends "base.html" %}
{% block content %}
  <div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">月次 食材原価率（理想{{ (ideal_ratio*100)|round(0) }}%との差）</h2>

    <form method="get" action="{{ url_for('monthly_food_cost') }}" class="mb-3">
      <label>対象月</label>
      <input type="month" name="ym" value="{{ ym }}">

      <button type="submit" class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">表示</button>
    </form>

    <p class="muted">期間：{{ start_date }} 〜 {{ next_date }}（{{ next_date }}は含まない）</p>

    {% if begin_missing %}
      <p class="text-sm text-red-700"><span class="font-semibold">注意：</span>期首棚卸（前月末の月次棚卸）が見つかりません。期首在庫は0として計算しています。</p>
    {% else %}
      <p class="muted">期首棚卸：{{ begin_taken_at }}</p>
    {% endif %}

    {% if end_missing %}
      <p class="text-sm text-red-700"><span class="font-semibold">注意：</span>当月の期末棚卸（月次棚卸）が見つかりません。期末在庫は0として計算しています。</p>
    {% else %}
      <p class="muted">期末棚卸：{{ end_taken_at }}</p>
    {% endif %}

    <hr class="my-4 border-slate-200">

    <div class="overflow-x-auto -mx-4 sm:mx-0">

      <table class="min-w-[640px] w-full text-sm">
      <tbody>
        <tr><th>売上（円）</th><td>{{ "%.0f"|format(sales) }}</td></tr>
        <tr><th>期首在庫金額（円）</th><td>{{ "%.0f"|format(begin_value) }}</td></tr>
        <tr><th>当月仕入金額（円）</th><td>{{ "%.0f"|format(purchases_cost) }}</td></tr>
        <tr><th>期末在庫金額（円）</th><td>{{ "%.0f"|format(end_value) }}</td></tr>
        <tr><th>食材原価（COGS）（円）</th><td><b>{{ "%.0f"|format(cogs) }}</b></td></tr>
        <tr>
          <th>食材原価率</th>
          <td>
            {% if ratio is none %}
              売上が0のため計算不可
            {% else %}
              <b>{{ (ratio*100)|round(1) }}%</b>
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>理想{{ (ideal_ratio*100)|round(0) }}%との差</th>
          <td>
            {% if ratio is none %}
              -
            {% else %}
              <b>{{ diff_pp|round(1) }}pp</b>
              （{{ "%.0f"|format(diff_yen) }}円）
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>
    </div>

    <hr class="my-4 border-slate-200">

    <h3 class="text-base font-semibold text-slate-900">当月仕入内訳（FOOD）</h3>
    <div class="overflow-x-auto -mx-4 sm:mx-0">
      <table class="min-w-[640px] w-full text-sm">
      <thead>
        <tr>
          <th>材料</th>
          <th>数量合計</th>
          <th>単位</th>
          <th>金額（円）</th>
        </tr>
      </thead>
      <tbody>
        {% for r in purchase_breakdown %}
          <tr>
            <td>{{ r["name"] }}</td>
            <td>{{ "%.2f"|format(r["qty_sum"]) }}</td>
            <td>{{ r["unit_base"] }}</td>
            <td>{{ "%.0f"|format(r["amount"]) }}</td>
          </tr>
        {% else %}
          <tr><td colspan="4">仕入データがありません。</td></tr>
        {% endfor %}
      </tbody>
    </table>
    </div>

    <hr class="my-4 border-slate-200">

    <h3 class="text-base font-semibold text-slate-900">期末棚卸内訳（FOOD）</h3>
    {% if end_missing %}
      <p>期末棚卸がないため表示できません。</p>
    {% else %}
      <div class="overflow-x-auto -mx-4 sm:mx-0">
        <table class="min-w-[640px] w-full text-sm">
        <thead>
          <tr>
            <th>材料</th>
            <th>数量</th>
            <th>単位</th>
            <th>参考単価</th>
            <th>金額（円）</th>
          </tr>
        </thead>
        <tbody>
          {% for r in end_lines %}
            <tr>
              <td>{{ r["name"] }}</td>
              <td>{{ "%.2f"|format(r["counted_qty"]) }}</td>
              <td>{{ r["unit_base"] }}</td>
              <td>{{ "%.0f"|format(r["ref_unit_price"]) }}</td>
              <td>{{ "%.0f"|format(r["amount"]) }}</td>
            </tr>
          {% else %}
            <tr><td colspan="5">棚卸明細がありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    {% endif %}
  </div>
{% endblock %}
