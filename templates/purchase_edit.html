{% extends "base.html" %}
{% block content %}
  <div class="card rounded-2xl border border-slate-200 bg-white p-4 sm:p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">入庫編集（ID: {{ header["purchase_id"] }}）</h2>

    <form method="post" action="{{ url_for('purchase_update', purchase_id=header['purchase_id']) }}">
      <label>仕入れ先（任意）</label>
      <select name="supplier_id">
        <option value="">未設定</option>
        {% for s in suppliers %}
          <option value="{{ s['supplier_id'] }}"
            {{ "selected" if header["supplier_id"] == s["supplier_id"] else "" }}>
            {{ s['name'] }}
          </option>
        {% endfor %}
      </select>

      <div>
        <label>仕入れ日（任意）</label>
        <input type="date" name="purchased_date" value="{{ default_purchased_date }}">
        <div class="muted">空なら元の日付を使います</div>
      </div>

      <label>メモ（任意）</label>
      <input name="note" value="{{ header['note'] or '' }}">

      <hr class="my-4 border-slate-200">

      <h3 class="text-base font-semibold text-slate-900">明細（最大10行）</h3>
      <p class="muted">数量(qty)の単位は材料の unit_base に合わせてください（g / ml / pcs など）</p>

      <div class="overflow-x-auto -mx-4 sm:mx-0">

        <table class="min-w-[640px] w-full text-sm">
        <thead>
          <tr>
            <th class="w-[45%]">材料</th>
            <th class="w-[20%]">数量(qty)</th>
            <th class="w-[20%]">単価(数量入力時は必須)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in line_rows %}
            <tr>
              <td>
                <select name="item_id">
                  <option value="">選択してください</option>
                  {% for i in items %}
                    <option value="{{ i['item_id'] }}"
                      {{ "selected" if row["item_id"] == i["item_id"] else "" }}>
                      {{ i['name'] }}（{{ i['unit_base'] }}）
                    </option>
                  {% endfor %}
                </select>
              </td>
              <td><input name="qty" type="number" step="1" min="0" value="{{ '%.0f'|format(row['qty']|float) if (row['qty'] is not none and row['qty'] != '') else '' }}"></td>
              <td><input name="unit_price" type="number" step="1" min="0" value="{{ row['unit_price'] if row['unit_price'] is not none else '' }}"></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>

      <div class="actions mt-4 flex flex-wrap items-center gap-2">
        <button class="btn inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400" type="submit">更新する</button>
        <a class="btn secondary inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50" href="{{ url_for('purchase_detail', purchase_id=header['purchase_id']) }}">戻る</a>
      </div>
    </form>
  </div>
{% endblock %}
